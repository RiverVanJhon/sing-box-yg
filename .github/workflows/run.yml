name: Keep Servers Alive

on:
  schedule:
   #- cron: '0 */11 * * *' # å®šé—´éš”è¿è¡Œï¼Œæ¯11å°æ—¶æ‰§è¡Œä¸€æ¬¡
   #- cron: '0 18 * * *' # å®šæ—¶è¿è¡Œï¼ŒUTCæ—¶é—´ä¸‹åˆ6ç‚¹ï¼Œå³åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹
  workflow_dispatch: 
  
jobs:
  keep_servers_alive:
    runs-on: ubuntu-latest
    env:
      ACCOUNTS: ${{ secrets.ACCOUNTS }}  # ACCOUNTSæ˜¯ä»GitHub Secretsä¸­è¯»å–çš„
      isres: '["n", "n"]'  # æ˜¯å¦é‡ç½®å®‰è£…ï¼Œä¸ACCOUNTSçš„æ•°é‡ä¸€è‡´
      isshow: 'n'  # æ·»åŠ isshowï¼Œæ˜¯å¦æ‰“å°è¾“å‡ºç»“æœ

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass curl jq

      - name: Process each account
        run: |
          count=0  
          ISRES=($(echo "$isres" | jq -r '.[]'))
          ISSHOW="$isshow"  # å°†isshowèµ‹å€¼ç»™ISSHOWå˜é‡ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨

          # å®šä¹‰run_remote_commandå‡½æ•°
          run_remote_command() {
            local RES=$1
            local SSH_USER=$2
            local SSH_PASS=$3
            local REALITY=${4}
            local SUUID=$5
            local TCP1_PORT=$6
            local TCP2_PORT=$7
            local UDP_PORT=$8
            local HOST=$9
            local ARGO_DOMAIN=${10}
            local ARGO_AUTH=${11}

            if [ -z "${ARGO_DOMAIN}" ]; then
              echo "ArgoåŸŸåä¸ºç©ºï¼Œç”³è¯·Argoä¸´æ—¶åŸŸå"
            else
              #æ•æ„Ÿä¿¡æ¯
              echo "Argoå·²è®¾ç½®å›ºå®šåŸŸåï¼š${ARGO_DOMAIN}"
            fi

            remote_command="export reym=$REALITY UUID=$SUUID vless_port=$TCP1_PORT vmess_port=$TCP2_PORT hy2_port=$UDP_port reset=$RES ARGO_DOMAIN=${ARGO_DOMAIN} ARGO_AUTH=${ARGO_AUTH} && bash <(curl -Ls https://raw.githubusercontent.com/yonggekkk/sing-box-yg/main/serv00keep.sh)"
            #æ•æ„Ÿä¿¡æ¯
            echo "Executing remote command on $HOST as $SSH_USER with command: $remote_command"
            sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$HOST" "$remote_command"
          }

          # ç‰ˆæƒå£°æ˜
          echo "*****************************************************"
          echo "*****************************************************"
          echo "ç”¬å“¥Githubé¡¹ç›®  ï¼šgithub.com/yonggekkk"
          echo "ç”¬å“¥Bloggeråšå®¢ ï¼šygkkk.blogspot.com"
          echo "ç”¬å“¥YouTubeé¢‘é“ ï¼šwww.youtube.com/@ygkkk"
          echo "è‡ªåŠ¨è¿œç¨‹éƒ¨ç½²å¹¶ä¿æ´»Serv00ä¸‰åˆä¸€åè®®è„šæœ¬ã€Githubã€‘"
          echo "ç‰ˆæœ¬ï¼šV25.1.22"
          echo "*****************************************************"
          echo "*****************************************************"

          for account in $(echo "${ACCOUNTS}" | jq -c '.[]'); do
            count=$((count+1))
            RES=${ISRES[$((count-1))]}  # æ ¹æ®ç´¢å¼•ä»isresæ•°ç»„ä¸­è·å–RESå€¼
            SSH_USER=$(echo $account | jq -r '.SSH_USER')
            SSH_PASS=$(echo $account | jq -r '.SSH_PASS')
            REALITY=$(echo $account | jq -r '.REALITY')
            SUUID=$(echo $account | jq -r '.SUUID')
            TCP1_PORT=$(echo $account | jq -r '.TCP1_PORT')
            TCP2_PORT=$(echo $account | jq -r '.TCP2_PORT')
            UDP_PORT=$(echo $account | jq -r '.UDP_PORT')
            HOST=$(echo $account | jq -r '.HOST')
            ARGO_DOMAIN=$(echo $account | jq -r '.ARGO_DOMAIN')
            ARGO_AUTH=$(echo $account | jq -r '.ARGO_AUTH') 
            if sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$HOST" -q exit; then
              echo "ğŸ‰æ­å–œï¼âœ…ç¬¬ã€$countã€‘å°æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼ğŸš€"   
              if [ -z "${ARGO_DOMAIN}" ]; then
                check_process="ps aux | grep '[c]onfig' > /dev/null && ps aux | grep [l]ocalhost:$TCP2_PORT > /dev/null"
              else
                check_process="ps aux | grep '[c]onfig' > /dev/null && ps aux | grep '[t]oken $ARGO_AUTH' > /dev/null"
              fi

              
              if ! sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$HOST" "$check_process" || [[ "$RES" =~ ^[Yy]$ ]]; then
                  echo "âš ï¸æ£€æµ‹åˆ°ä¸»è¿›ç¨‹æˆ–è€…argoè¿›ç¨‹æœªå¯åŠ¨ï¼Œæˆ–è€…æ‰§è¡Œé‡ç½®"
                  echo "âš ï¸ç°åœ¨å¼€å§‹ä¿®å¤æˆ–é‡ç½®éƒ¨ç½²â€¦â€¦è¯·ç¨ç­‰"
                  echo "âš ï¸æç¤ºError: Process completed with exit code 255ä¸­æ–­å¹¶é€€å‡ºæ—¶ï¼Œè¯´æ˜è®¾ç½®éšæœºç«¯å£å®Œæˆï¼Œè¯·æŠŠRESè®¾ç½®ä¸ºnå†æ‰§è¡Œå³å¯"
                  output=$(run_remote_command "$RES" "$SSH_USER" "$SSH_PASS" "${REALITY}" "$SUUID" "$TCP1_PORT" "$TCP2_PORT" "$UDP_PORT" "$HOST" "${ARGO_DOMAIN}" "${ARGO_AUTH}")
                  
                  if [[ "$ISSHOW" == "y" || "$ISSHOW" == "Y" ]]; then
                      echo "è¿œç¨‹å‘½ä»¤æ‰§è¡Œç»“æœï¼š$output"
                  else
                      echo "æ‰§è¡Œå®Œæˆã€‚"
                  fi
              else
                  echo "ğŸ‰æ­å–œï¼âœ…æ£€æµ‹åˆ°æ‰€æœ‰è¿›ç¨‹æ­£å¸¸è¿è¡Œä¸­ "
                  echo "é…ç½®æ˜¾ç¤ºå¦‚ä¸‹ï¼š"
                  if [[ "$ISSHOW" == "y" || "$ISSHOW" == "Y" ]]; then
                      sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$HOST" \
                         "cat domains/\$(whoami).serv00.net/logs/list.txt; \
                          echo '===================================================='"
                  else
                      echo "æ‰§è¡Œå®Œæˆã€‚"
                  fi
              fi
            else
              echo "===================================================="
              echo "ğŸ’¥æ¯å…·ï¼âŒç¬¬ã€$countã€‘å°æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼"
              echo "âš ï¸å¯èƒ½è´¦å·åã€å¯†ç ã€æœåŠ¡å™¨åç§°è¾“å…¥é”™è¯¯ï¼Œæˆ–è€…å½“å‰æœåŠ¡å™¨åœ¨ç»´æŠ¤ä¸­"  
              echo "===================================================="
            fi
          done
